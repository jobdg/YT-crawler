<?php// based on TubeKit by Chirag Shah// Author: Job de Groot// Date: 08/03/2014ini_set('display_startup_errors',1);ini_set('display_errors',1);error_reporting(-1);ini_set("memory_limit","100M");require_once("config.php");require_once("$mpdirectory/rss_fetch.inc");require_once("parseRSS2.php");require_once("functions.php");//set config:$t=getdate();$DATA['today_in']=date('Y-m-d',$t[0]);$qTableName = $prefix . "_queries";$oTableName_in = $prefix . "_once";setstatus("STARTING RELATED",1);//laod all queries to be checked:$query = "SELECT * FROM thesis__related WHERE status = 0";$vresult = mysql_query($query) or die(" ". mysql_error());while($VID=mysql_fetch_array($vresult))	{	echo "<hr>".$ytID_in = $VID['related'];	//checkl if there is a video in the DB with this ID	$query = "SELECT * from $oTableName_in WHERE yt_id='$ytID_in'";	$result = mysql_query($query) or mysql_error();	$num_rows = mysql_num_rows($result);	// Only if there wasn't already a video with the same ID for the same query, process further  	if ($num_rows == 0)					  		{		echo "<hr>--new video:".$ytID_in;		$feedURL = "http://gdata.youtube.com/feeds/api/videos/$ytID_in?v=2&alt=jsonc";		echo "<br>Loading Feed Url: ".$feedURL;		//updating related status		$sql = "UPDATE  `thesis__related` SET  `status` =  '1' WHERE  related = '$ytID_in'";		mysql_query($sql);				//load data		$data = loaddata($feedURL,$ytID_in,"json");		if($data[1]!='')			{			continue;			}		else			{			$entry=$data[0];			}		//process data		$video = parseVideoEntry($entry);		$timestamp = time();		if($video)			{			echo "<br>Adding video:" .$video->title."\n";			//preparing data			$DATA['title'] = str_replace("'", "#39", $video->title);			$DATA['description'] = str_replace("'", "#39", $video->description);			$DATA['username'] = str_replace("'", "#39",$video->username);			$DATA['name'] = str_replace("'", "#39",$video->name);			$DATA['upload_time'] = $video->published;			$DATA['duration'] = $video->length;			$DATA['category'] = $video->category;			//$DATA['keywords'] = $video->keywords;			$DATA['video_url'] = $video->watchURL;			$DATA['user_subs'] = $video->subs;			$DATA['user_views'] = $video->views;			$DATA['user_upl'] = $video->usr_uploads;			$DATA['user_favs'] = $video->usr_favs;			$DATA['user_contacts'] = $video->usr_contacts;			$DATA['user_created'] = $video->usr_created;			$DATA['thumb_url'] = $video->thumbnailURL;//'http://i1.ytimg.com/vi/' . $ytID_in . '/0.jpg';			$DATA['timestamp'] = $timestamp;			$DATA['qid_in'] = $qid_in;			$DATA['ytID_in'] = $ytID_in;                            		   			//storing DATA			insert_DB_new($DATA);			// Related video code			$related_url='http://gdata.youtube.com/feeds/api/videos/'.$DATA['ytID_in'].'/related?v=2'.'&max-results=20';						//only load 1st degree for now			if ($VID['degree']==0) 			{				//set new degree				$VID['new_degree']=$VID['degree']+1;				//loading related data				$data = loaddata($related_url,$ytID_in,"xml");				if($data[1]!='')					{					continue;					}				else					{					$relatedFeed=$data[0];					}				$count = 0;				foreach ($relatedFeed->entry as $related)					{					$count++;					$video_in = parseVideoEntry2($related);					$timestamp_in = time();					echo "<hr>Related Video Title [".$count."] :";					$ex=explode("=",$video_in->watchURL);					$ex=explode("&",$ex[1]);					$relatedvid=$ex[0];					echo $video_in->title."<br>";					$query = "INSERT INTO thesis__related (source,related,degree)  							VALUES ('".$DATA['ytID_in']."', '".$relatedvid."',".$VID['new_degree'].")";								if(!mysql_query($query))						{						setstatus("FATAL ERROR: DB saving related video",1);						echo "<pre>".$query."</pre>";						echo "<br>ERRROR:".mysql_error();						die();		                                                       						} 					}				}//end related code				}//$video check		} // if ($num_rows == 0)	else		{		//updating related status		echo "<hr>".$sql = "UPDATE  `thesis__related` SET  `status` =  '2' WHERE  related = '$ytID_in'";		mysql_query($sql);		echo " Already exists";		}			} // foreach ($rss->items as $item) echo "<hr> Done";setstatus("DONE: related",1);			 ?>